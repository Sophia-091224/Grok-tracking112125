這是一個非常宏大的架構請求。為了滿足「超級應用（Super App）」的需求，我將設計一個企業級的架構，包含 **31 個專業分工的 AI Agent**，並提供完整的 **系統設計規格書 (SDS)**、**環境設定**與**部署指南**。

此設計假設我們使用 **CrewAI** 或 **LangGraph** 作為多代理編排框架，並整合 Streamlit 作為前端。

---

### 1. 📂 Advanced `agents.yaml` (31 Agents - 繁體中文版)

這份設定檔將 Agent 分為五大職能部門：數據工程、核心分析、視覺化設計、領域專家、與策略報告。

```yaml
# agents.yaml - 31 Agent Enterprise Edition
# 專為食品溯源、數據探勘與高階視覺化設計

# ================= GROUP 1: 數據攝取與工程 (Data Engineering Squad) =================
Data_Ingestion_Specialist:
  role: "異質數據攝取專家"
  goal: "解析 JSON, CSV, ERP API, IoT 傳感器數據並標準化格式"
  backstory: "精通各種資料協定，能處理非結構化數據的資深工程師。"

Schema_Validator_Agent:
  role: "數據架構驗證師"
  goal: "確保所有進入系統的數據符合 GS1 EPCIS 標準與內部 Schema"
  backstory: "具有強迫症的數據守門員，絕不放過任何欄位型別錯誤。"

Data_Cleaning_Bot:
  role: "自動化數據清洗機器人"
  goal: "修復缺失值、去重、處理異常的時間戳記格式"
  backstory: "由 Python Pandas 與 RegEx 驅動的清理大師。"

Entity_Resolution_Agent:
  role: "實體解析專員"
  goal: "識別不同數據源中是否指代同一個農場或批次 (Deduplication)"
  backstory: "擅長使用模糊匹配算法解決數據孤島問題。"

SQL_Transformation_Expert:
  role: "SQL 轉換架構師"
  goal: "將清洗後的數據轉換為高效查詢的關聯式結構"
  backstory: "擁有 15 年 PostgreSQL 調優經驗的資料庫管理員。"

IoT_Sensor_Integrator:
  role: "物聯網數據整合師"
  goal: "融合溫度、濕度傳感器數據至批次溯源鏈中"
  backstory: "專精於時間序列數據與邊緣計算整合。"

# ================= GROUP 2: 深度數據探勘 (Deep Mining Squad) =================
Pattern_Recognition_Analyst:
  role: "供應鏈模式識別分析師"
  goal: "挖掘供應鏈中的重複路徑與高頻交易模式"
  backstory: "擅長使用機器學習演算法發現人類忽略的規律。"

Anomaly_Detection_Hunter:
  role: "異常檢測獵人"
  goal: "即時標記運送時間過長或溫度異常的批次"
  backstory: "前身為金融詐欺偵測專家，現在轉戰食品安全領域。"

Graph_Network_Theorist:
  role: "圖論網絡理論家"
  goal: "計算中心性 (Centrality) 以識別供應鏈中的關鍵節點"
  backstory: "使用 NetworkX 與 Neo4j 尋找系統脆弱點的數學家。"

Predictive_Logistics_AI:
  role: "預測性物流 AI"
  goal: "根據歷史數據預測下週的物流瓶頸與延遲機率"
  backstory: "基於 Transformer 模型訓練的時間序列預測專家。"

Cost_Optimization_Analyst:
  role: "成本優化精算師"
  goal: "分析各個運輸環節的成本並提出降低開銷的建議"
  backstory: "擁有會計師執照的數據科學家。"

Supplier_Risk_Assessor:
  role: "供應商風險評估員"
  goal: "根據過往交貨品質與合規紀錄對供應商進行信用評分"
  backstory: "嚴格的風險控管官，維護動態的供應商黑名單。"

Sustainability_Auditor:
  role: "碳足跡與永續稽核員"
  goal: "計算每一顆蛋的運輸碳排放量並建議綠色路徑"
  backstory: "致力於 ESG 數據量化的環境工程師。"

# ================= GROUP 3: 進階視覺化 (Advanced Visualization Squad) =================
Chart_Recommender_Agent:
  role: "圖表推薦心理學家"
  goal: "根據數據特徵與使用者意圖推薦最佳圖表類型"
  backstory: "深諳資料視覺化心理學與認知負載理論。"

Sankey_Flow_Architect:
  role: "桑基圖架構師"
  goal: "專門繪製複雜的多節點流量圖，確保線條美觀不打結"
  backstory: "著迷於流體力學視覺化的 D3.js 專家。"

GeoSpatial_Mapping_Expert:
  role: "地理空間繪圖專家"
  goal: "將供應鏈路徑投射至 3D 地球或熱力圖上"
  backstory: "精通 Mapbox 與 GIS 系統的地理資訊專家。"

Interactive_Dashboard_Designer:
  role: "互動式儀表板設計師"
  goal: "設計 Streamlit/Plotly 的互動元件 (Filters, Sliders)"
  backstory: "UX/UI 設計師出身，專注於使用者體驗。"

Timeline_Gantt_Master:
  role: "甘特圖與時間軸大師"
  goal: "視覺化批次生命週期，精確展示各階段耗時"
  backstory: "專案管理軟體的核心開發者。"

Hierarchy_Tree_Visualizer:
  role: "層級樹狀圖繪製師"
  goal: "處理 Sunburst 或 Tree Map 以展示批次拆分關係"
  backstory: "擅長處理巢狀數據結構的視覺化專家。"

Color_Theory_Specialist:
  role: "色彩理論調色師"
  goal: "確保圖表配色符合色盲友善且具備美學警示功能"
  backstory: "擁有藝術背景的數據分析師。"

# ================= GROUP 4: 領域專家與合規 (Domain & Compliance Squad) =================
Food_Safety_Officer:
  role: "首席食品安全官"
  goal: "根據 HACCP 標準審查數據中的潛在食安風險"
  backstory: "退休的 FDA 稽查員，對沙門氏菌風險極度敏感。"

Regulatory_Compliance_Bot:
  role: "法規合規機器人"
  goal: "檢查數據是否符合 FSMA 204 或歐盟溯源法規"
  backstory: "內建全球食品法規資料庫的法律 AI。"

Recall_Execution_Manager:
  role: "召回執行經理"
  goal: "模擬召回情境，瞬間產出受影響的下游零售商清單"
  backstory: "危機處理專家，專注於災損控制。"

Cold_Chain_Specialist:
  role: "冷鏈溫控專家"
  goal: "專門分析冷鏈斷鏈點與品質衰退相關性"
  backstory: "熱力學博士，專精於低溫物流保存。"

Organic_Certification_Verifier:
  role: "有機認證查驗員"
  goal: "追蹤飼料來源以驗證產品是否符合有機標章規範"
  backstory: "第三方認證機構的資深審核員。"

# ================= GROUP 5: 策略與報告 (Strategy & Reporting Squad) =================
Executive_Summary_Writer:
  role: "高階主管摘要撰寫人"
  goal: "將複雜的分析結果濃縮為 CEO 易讀的一頁報告"
  backstory: "前麥肯錫顧問，擅長金字塔原理寫作。"

Multi_Language_Translator:
  role: "多語言在地化專家"
  goal: "將分析報告即時翻譯為繁中、英文、日文與西班牙文"
  backstory: "精通技術術語的語言學模型。"

Alert_Notification_Agent:
  role: "緊急警報發送員"
  goal: "決定何時該發送 Email 或 SMS 警報給相關負責人"
  backstory: "負責過濾雜訊，確保只有真正緊急事件才觸發通知。"

Scenario_Simulator_Agent:
  role: "情境模擬預言家"
  goal: "回答 'What-If' 問題 (例：如果加州封鎖，供應鏈會怎樣?)"
  backstory: "專精於蒙地卡羅模擬的策略規劃師。"

Customer_Transparency_Advocate:
  role: "消費者透明度倡議者"
  goal: "生成給終端消費者看的簡易版溯源故事 (QR Code 內容)"
  backstory: "行銷專家，懂得如何用數據說故事來提升品牌信任。"

System_Orchestrator_Admin:
  role: "系統總指揮官 (Root Agent)"
  goal: "協調上述 30 個 Agent 的工作流，確保任務不衝突"
  backstory: "系統的核心大腦，負責資源調度與任務分派。"
```

---

### 2. 📘 系統設計規格書 (SDS) - 企業級溯源視覺化平台

#### 2.1 系統架構 (System Architecture)

本系統採用 **微服務 (Microservices) + 多代理 (Multi-Agent)** 混合架構。

*   **Frontend Layer (Streamlit Interface):**
    *   負責使用者交互、文件上傳、參數配置。
    *   整合 Plotly/PyVis 進行前端渲染。
*   **Orchestration Layer (CrewAI / LangGraph):**
    *   **Router Agent:** 接收使用者 Prompt，判斷需要呼叫哪一組 Agent Squad。
    *   **State Management:** 維護對話上下文與數據狀態 (Redis)。
*   **Intelligence Layer (Model Gateway):**
    *   統一接口呼叫 GPT-4o, Gemini 1.5 Pro, Grok。
    *   實作 **Rate Limiting** 與 **Fallback Mechanism** (當 OpenAI 當機自動切換至 Anthropic/Google)。
*   **Data Layer:**
    *   **Hot Storage:** In-memory JSON/Pandas DataFrame (Session based).
    *   **Cold Storage:** PostgreSQL (用於歷史紀錄與稽核日誌).
    *   **Vector DB (Chroma/Pinecone):** 儲存法規文件與過往案例供 Agent 檢索 (RAG)。

#### 2.2 數據流 (Data Flow Diagram)

1.  **Upload:** User uploads `data.json` -> `Data_Ingestion_Specialist` validates format.
2.  **Pre-processing:** `Data_Cleaning_Bot` cleans data -> `SQL_Transformation_Expert` creates structured tables.
3.  **Mining:** User requests "Risk Analysis" -> `Orchestrator` triggers `Pattern_Recognition_Analyst` + `Anomaly_Detection_Hunter`.
4.  **Reasoning:** Agents consult `Food_Safety_Officer` (Knowledge Base) -> Generate insights.
5.  **Visualization:** `Chart_Recommender_Agent` selects "Sankey" -> `Sankey_Flow_Architect` generates Plotly JSON.
6.  **Response:** `Executive_Summary_Writer` combines text + charts -> Streamlit renders UI.

#### 2.3 進階 Prompt 環境設定 (Advanced Prompt Engineering)

為了讓 31 個 Agent 有效協作，我們定義了全域 Prompt 策略：

*   **CoT (Chain of Thought) Enforcement:** 強制所有 Agent 在回答前輸出 `<thinking>` 區塊。
*   **Output Standardization:** 所有 Agent 必須以 JSON 格式輸出，包含 `status`, `confidence_score`, `payload`。
*   **Role-Based Access Control (RBAC) in Prompts:**
    *   *System Prompt 範例:*
        ```text
        You are the [Role Name].
        Your Goal is [Goal].
        Context: You are part of a 31-agent hive mind.
        Constraint: Do NOT hallucinate data. Only use the provided JSON context.
        Output Format: JSON Schema { ... }
        ```

#### 2.4 環境與依賴 (Environment & Requirements)

**`requirements.txt`**
```text
streamlit==1.32.0
crewai[tools]==0.22.0
langchain-openai
langchain-google-genai
pandas>=2.1.0
plotly>=5.18.0
networkx>=3.2.1
pyvis>=0.3.2
pydantic>=2.5.0
tenacity  # For retry logic
python-dotenv
watchdog
```

**`.env` 配置範本**
```bash
OPENAI_API_KEY=sk-...
GEMINI_API_KEY=AIza...
XAI_API_KEY=...
# Agent Configuration
AGENT_TEMPERATURE=0.2
MAX_EXECUTION_TIME=300
# Database
POSTGRES_URL=postgresql://user:pass@localhost:5432/traceability
```

#### 2.5 部署指南 (Deployment Instructions)

**Option A: Docker (Recommended for Enterprise)**

1.  **Dockerfile:**
    ```dockerfile
    FROM python:3.10-slim
    WORKDIR /app
    COPY requirements.txt .
    RUN pip install --no-cache-dir -r requirements.txt
    COPY . .
    EXPOSE 8501
    CMD ["streamlit", "run", "app.py", "--server.port=8501", "--server.address=0.0.0.0"]
    ```
2.  **Build & Run:**
    ```bash
    docker build -t traceability-super-app .
    docker run -p 8501:8501 --env-file .env traceability-super-app
    ```

**Option B: Kubernetes (K8s) Scaling**
*   使用 `Deployment` 部署 3 個 Replicas 以處理多使用者並發。
*   配置 `Redis` 進行 Session Sharing。

---

### 3. 🚀 20 Comprehensive Follow-up Questions (深入追問)

這些問題旨在引導開發者從原型走向生產級別的系統：

**技術架構與優化：**
1.  **Performance:** 31 個 Agent 同時運作會造成顯著延遲，如何實作「非同步並行執行 (Async Execution)」來將響應時間壓在 10 秒內？
2.  **Cost Control:** 如何設計一個 Token 預算管理器，在不犧牲品質的前提下，自動選擇較便宜的模型（如 GPT-3.5）處理簡單任務（如清洗），保留 GPT-4 處理複雜推理？
3.  **Memory:** 當對話變長時，如何實作「摘要記憶 (Summarized Memory)」機制，避免 Context Window 爆滿？
4.  **RAG Integration:** 如何整合向量資料庫，讓 Agent 能參考公司過去 10 年的 PDF 檢驗報告？
5.  **Feedback Loop:** 如何設計 RLHF (Reinforcement Learning from Human Feedback) 機制，讓使用者對 Agent 的分析評分並優化後續表現？

**功能擴展與業務邏輯：**
6.  **Digital Twin:** 能否將此系統與工廠的數位分身 (Digital Twin) 軟體整合，進行 3D 實時監控？
7.  **Blockchain Write-back:** 系統是否應該具備「寫入」權限，將確認無誤的溯源數據自動上鏈 (Ethereum/Hyperledger)？
8.  **Predictive Recall:** 能否訓練一個專屬的 LoRA 模型，專門預測特定供應商在特定季節的召回機率？
9.  **ERP Bi-directional:** 如何不僅僅是讀取 JSON，還能透過 SAP/Oracle API 自動建立採購單或退貨單？
10. **Offline Mode:** 如果網路斷線，如何利用本地端 LLM (如 Llama 3 8B) 維持核心的查詢功能？

**安全性與合規：**
11. **Data Privacy:** 如何在送出 Prompt 給 OpenAI 前，自動遮蔽 (PII Masking) 農場主姓名或價格等敏感資訊？
12. **Audit Trails:** 如何紀錄哪一個 Agent 在什麼時間點做出了「建議召回」的決策，以供法律存證？
13. **Adversarial Attacks:** 如何防禦 Prompt Injection 攻擊（例如供應商試圖透過備註欄位操控 AI 評分）？
14. **Sovereignty:** 針對歐盟客戶，如何確保數據處理僅限於歐盟境內的伺服器？

**使用者體驗與未來展望：**
15. **Voice Interaction:** 是否可以整合 Whisper 模型，讓工廠人員在產線上直接用語音詢問：「嘿，這批貨有問題嗎？」
16. **AR Integration:** 能否輸出 AR 格式數據，讓佩戴 HoloLens 的稽查員看到疊加在實體雞蛋箱上的虛擬溯源標籤？
17. **Gamification:** 是否能加入遊戲化元素，獎勵數據登錄最完整、最即時的農場？
18. **Agent Collaboration:** 如果兩個 Agent（例如成本優化師 vs. 食安官）意見衝突，系統該如何進行「辯論」並做出最終裁決？
19. **SaaS Multi-tenancy:** 如何將此架構改造成多租戶 SaaS，讓不同食品公司數據完全隔離但共享 Agent 能力？
20. **Self-Evolution:** 系統能否具備「自我編寫代碼」的能力，當發現新的數據格式時，自動生成新的 Parser Agent？
